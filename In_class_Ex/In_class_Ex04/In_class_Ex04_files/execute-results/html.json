{
  "hash": "21d3e32a599b24b1d7ed39a3f2b37519",
  "result": {
    "markdown": "---\ntitle: \"Geospatially Weighted Poisson Regression\"\nauthor: \"Wan Kee\"\ndate: \"9 December 2023\"\ndate modified: \"9 December 2023\"\nformat: html\nexecute: \n  echo: true\n  eval: true\n  warning: false\neditor: source\n---\n\n\n# 1. Overview\n\nLearning Objectives 1. Perform geocoding by using SLA OneMap API 2. Convert an aspatial data into a simple feature tibble data.frame 3. Perform point-in-polygon count analysis 4. Append the propulsiveness and attractiveness variables onto a flow data.\n\n# 2. Load packages\n\nThe analysis involves the following packages:\n\n-   `sf` imports and handles geospatial data\n-   `httr` provide a wrapper for the curl package, customised to the demands of modern web APIs.\n-   `tidyverse` performs aspatial data import, wrangling and visualization\n-   `tmap` supports data visualisation\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, sf, httr, tmap)\n```\n:::\n\n\n# 3. Import data\n\n::: panel-tabset\n## School\n\n`school` is an **aspatial** dataset where all the school directory and information is available for download [here](https://beta.data.gov.sg/collections/457/datasets/d_9aba12b5527843afb0b2e8e4ed6ac6bd/view). \nThe output indicates that there are **346 features** and 31 fields.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nschool <- read_csv(\"data/aspatial/Generalinformationofschools.csv\")\nglimpse(school)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 346\nColumns: 31\n$ school_name        <chr> \"ADMIRALTY PRIMARY SCHOOL\", \"ADMIRALTY SECONDARY SC…\n$ url_address        <chr> \"https://admiraltypri.moe.edu.sg/\", \"http://www.adm…\n$ address            <chr> \"11   WOODLANDS CIRCLE\", \"31   WOODLANDS CRESCENT\",…\n$ postal_code        <chr> \"738907\", \"737916\", \"768643\", \"768928\", \"579646\", \"…\n$ telephone_no       <chr> \"63620598\", \"63651733\", \"67592906\", \"67585384\", \"64…\n$ telephone_no_2     <chr> \"na\", \"63654596\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na…\n$ fax_no             <chr> \"63627512\", \"63652774\", \"67592927\", \"67557778\", \"64…\n$ fax_no_2           <chr> \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na…\n$ email_address      <chr> \"ADMIRALTY_PS@MOE.EDU.SG\", \"Admiralty_SS@moe.edu.sg…\n$ mrt_desc           <chr> \"Admiralty Station\", \"ADMIRALTY MRT\", \"Yishun\", \"CA…\n$ bus_desc           <chr> \"TIBS 965, 964, 913\", \"904\", \"Yishun Ring Road - 81…\n$ principal_name     <chr> \"MR PEK WEE HAUR\", \"MR LAM YUI- P'NG\", \"MISS ONG LE…\n$ first_vp_name      <chr> \"MDM CHUA MUI LING\", \"MR NG SONG LIM STEVEN\", \"MADA…\n$ second_vp_name     <chr> \"MDM NUR SABARIAH BTE MOHD IBRAHIM\", \"MR SHEIK ALAU…\n$ third_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ fourth_vp_name     <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ fifth_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ sixth_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ dgp_code           <chr> \"WOODLANDS\", \"WOODLANDS\", \"YISHUN\", \"YISHUN\", \"BISH…\n$ zone_code          <chr> \"NORTH\", \"NORTH\", \"NORTH\", \"NORTH\", \"SOUTH\", \"SOUTH…\n$ type_code          <chr> \"GOVERNMENT SCHOOL\", \"GOVERNMENT SCHOOL\", \"GOVERNME…\n$ nature_code        <chr> \"CO-ED SCHOOL\", \"CO-ED SCHOOL\", \"CO-ED SCHOOL\", \"CO…\n$ session_code       <chr> \"FULL DAY\", \"SINGLE SESSION\", \"SINGLE SESSION\", \"SI…\n$ mainlevel_code     <chr> \"PRIMARY\", \"SECONDARY\", \"PRIMARY\", \"SECONDARY\", \"PR…\n$ sap_ind            <chr> \"No\", \"No\", \"No\", \"No\", \"Yes\", \"No\", \"No\", \"No\", \"N…\n$ autonomous_ind     <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"Ye…\n$ gifted_ind         <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No…\n$ ip_ind             <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No…\n$ mothertongue1_code <chr> \"Chinese\", \"Chinese\", \"Chinese\", \"Chinese\", \"Chines…\n$ mothertongue2_code <chr> \"Malay\", \"Malay\", \"Malay\", \"Malay\", \"na\", \"Malay\", …\n$ mothertongue3_code <chr> \"Tamil\", \"Tamil\", \"Tamil\", \"Tamil\", \"na\", \"Tamil\", …\n```\n:::\n:::\n\n\n## mpsz\n\n`mpsz` is is a **geospatial** dataset of the Master Plan 2019, a forward looking guiding plan for Singapore's development in the medium term over the next 10 to 15 years published in **2019**.\n\nThe output indicates that the geospatial objects are **multipolygon** features. There are **332 features** and 6 fields. It is in **WGS84** projected coordinates system with **XY** dimension.\n\nSource: URA (Download [here](https://beta.data.gov.sg/collections/1749/view))\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz = st_read(dsn=\"data/geospatial\", layer=\"MPSZ-2019\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `MPSZ-2019' from data source \n  `/Users/chockwankee/Documents/chockwk/ISSS624_Geospatial_Analytics/In_class_Ex/In_class_Ex04/data/geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 332 features and 6 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775\nGeodetic CRS:  WGS 84\n```\n:::\n\n```{.r .cell-code}\nmpsz <- st_transform(mpsz, crs = 3414)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nst_crs(mpsz)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCoordinate Reference System:\n  User input: EPSG:3414 \n  wkt:\nPROJCRS[\"SVY21 / Singapore TM\",\n    BASEGEOGCRS[\"SVY21\",\n        DATUM[\"SVY21\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4757]],\n    CONVERSION[\"Singapore Transverse Mercator\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",1.36666666666667,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",103.833333333333,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",1,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",28001.642,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",38744.572,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"northing (N)\",north,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"easting (E)\",east,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Cadastre, engineering survey, topographic mapping.\"],\n        AREA[\"Singapore - onshore and offshore.\"],\n        BBOX[1.13,103.59,1.47,104.07]],\n    ID[\"EPSG\",3414]]\n```\n:::\n:::\n\n\n## Business\n\n`business` is is a **geospatial** dataset prepared by Prof Kam.\n\nThe output indicates that the geospatial objects are **point** features. There are **6,650 features** and 3 fields. It is in **SVY21** projected coordinates system with **XY** dimension.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbusiness = st_read(dsn=\"data/geospatial\", layer=\"Business\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `Business' from data source \n  `/Users/chockwankee/Documents/chockwk/ISSS624_Geospatial_Analytics/In_class_Ex/In_class_Ex04/data/geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 6550 features and 3 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 3669.148 ymin: 25408.41 xmax: 47034.83 ymax: 50148.54\nProjected CRS: SVY21 / Singapore TM\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(business)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 6,550\nColumns: 4\n$ POI_NAME   <chr> \"JOHN CHEN\", \"TROPICAL INDUSTRIAL BUILDING\", \"LIAN CHEONG I…\n$ POI_ST_NUM <chr> \"6\", \"14\", \"12\", NA, \"2\", \"21\", \"68\", \"68\", NA, \"14\", \"10\",…\n$ POI_ST_NAM <chr> \"LITTLE RD\", \"LITTLE RD\", \"LITTLE RD\", NA, \"LITTLE RD\", \"LO…\n$ geometry   <POINT [m]> POINT (33818.36 35620.16), POINT (33770.51 35610.2), …\n```\n:::\n:::\n\n:::\n\n# 4. Geocoding\n\n**Address geocoding** or **geocoding** is the process of identifying a **aspatial** description of a location on the Earth surface through its address, postcode, geographic coordinates or latitude/longitude pair.\n\nSingapore Land Authority (SLA) supports an online geocoding service called [OneMap API](https://www.onemap.gov.sg/apidocs/#onemap-rest-apis). The Search API looks up the address or 6-digit postal code for an entered value and returns both latitude, longitude and x,y coordinates of the searched location. \n\nStep 1: The input `school` is a csv. Select the postal code from into a list, which reads into the API efficiently. \n\n\n::: {.cell}\n\n```{.r .cell-code}\npostcodes <- school$postal_code\n```\n:::\n\n\nStep 2: Two tibble data frames are created, `found` contains all records geocoded correctly and `not_found` contains postal that failed to be geocoded.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfound <- data.frame()\nnot_found <- data.frame()\n```\n:::\n\n\nStep 3: A collection of http call functions of `httr`, such as `GET()` will pass the records to the geocoding server at OneMap. Obtain results from OneMap API, namely BLK_NO, ROAD_NAME, BUILDING, ADDRESS, POSTAL, X, Y, LATITUDE, LONGITUDE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://www.onemap.gov.sg/api/common/elastic/search\"\n\nfor (postcode in postcodes){\n  query <- list(\"searchVal\" = postcode,\n                \"returnGeom\" = \"Y\",\n                \"getAddrDetails\" = \"Y\",\n                \"pageNum\" = \"1\")\n  res <- GET(url , query = query)\n  \n  if((content(res)$found) != 0){\n    found <- rbind(found, data.frame(content(res))[4:13])\n  }else{\n    not_found = data.frame(postcode)\n  }\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(found)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 345\nColumns: 10\n$ results.SEARCHVAL <chr> \"THE LEARNING HARBOUR @ ADMIRALTY PRIMARY SCHOOL\", \"…\n$ results.BLK_NO    <chr> \"11\", \"31\", \"10\", \"751\", \"100\", \"2A\", \"31\", \"19\", \"1…\n$ results.ROAD_NAME <chr> \"WOODLANDS CIRCLE\", \"WOODLANDS CRESCENT\", \"YISHUN ST…\n$ results.BUILDING  <chr> \"THE LEARNING HARBOUR @ ADMIRALTY PRIMARY SCHOOL\", \"…\n$ results.ADDRESS   <chr> \"11 WOODLANDS CIRCLE THE LEARNING HARBOUR @ ADMIRALT…\n$ results.POSTAL    <chr> \"738907\", \"737916\", \"768643\", \"768928\", \"579646\", \"1…\n$ results.X         <chr> \"24315.9398124339\", \"24559.0472937012\", \"27958.13714…\n$ results.Y         <chr> \"47135.3542042952\", \"47504.7873554379\", \"46096.26276…\n$ results.LATITUDE  <chr> \"1.44254963931583\", \"1.44589068910993\", \"1.433152715…\n$ results.LONGITUDE <chr> \"103.800213682734\", \"103.802398196596\", \"103.8329424…\n```\n:::\n:::\n\n\nStep 3: Merge school information with geospatial data from OneMap API.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerged = merge(school, found, \n               by.x = \"postal_code\", \n               by.y = \"results.POSTAL\", \n               all = TRUE)\n\nwrite_csv(merged, file = \"data/aspatial/schools.csv\")\nwrite_csv(not_found, file = \"data/aspatial/not_found.csv\")\n\nglimpse(merged)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 350\nColumns: 40\n$ postal_code        <chr> \"088256\", \"099138\", \"099757\", \"099840\", \"109100\", \"…\n$ school_name        <chr> \"CANTONMENT PRIMARY SCHOOL\", \"CHIJ ST. THERESA'S CO…\n$ url_address        <chr> \"http://www.cantonmentpri.moe.edu.sg\", \"http://www.…\n$ address            <chr> \"1    Cantonment Close\", \"160  LOWER DELTA ROAD\", \"…\n$ telephone_no       <chr> \"65119555\", \"64775777\", \"62730096\", \"62733937\", \"62…\n$ telephone_no_2     <chr> \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na…\n$ fax_no             <chr> \"65119556\", \"64775700\", \"62731710\", \"62763083\", \"62…\n$ fax_no_2           <chr> \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na\", \"na…\n$ email_address      <chr> \"cantonment_ps@moe.edu.sg\", \"CHIJSTCS@MOE.EDU.SG\", …\n$ mrt_desc           <chr> \"Tanjong Pagar Outram Park\", \"HARBOURFRONT MRT, TIO…\n$ bus_desc           <chr> \"75, 167, 196\", \"65, 121, 123, 123M, 124, 131, 131M…\n$ principal_name     <chr> \"MRS MANOKARA SUGUNAVATHI\", \"MDM TAN MEI MEI JENNY\"…\n$ first_vp_name      <chr> \"MRS AUDREA CHIN\", \"MDM ONG LEE LEE\", \"MS NG CHIOU …\n$ second_vp_name     <chr> \"MISS CHENG SHIN MIIN\", \"MISS KUO ZHAOYAN, FELICIA\"…\n$ third_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ fourth_vp_name     <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ fifth_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ sixth_vp_name      <chr> \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NULL\", \"NU…\n$ dgp_code           <chr> \"BUKIT MERAH\", \"BUKIT MERAH\", \"BUKIT MERAH\", \"BUKIT…\n$ zone_code          <chr> \"SOUTH\", \"SOUTH\", \"SOUTH\", \"SOUTH\", \"SOUTH\", \"SOUTH…\n$ type_code          <chr> \"GOVERNMENT SCHOOL\", \"GOVERNMENT-AIDED SCH\", \"GOVER…\n$ nature_code        <chr> \"CO-ED SCHOOL\", \"GIRLS' SCHOOL\", \"GIRLS' SCHOOL\", \"…\n$ session_code       <chr> \"SINGLE SESSION\", \"SINGLE SESSION\", \"SINGLE SESSION…\n$ mainlevel_code     <chr> \"PRIMARY\", \"SECONDARY\", \"PRIMARY\", \"PRIMARY\", \"PRIM…\n$ sap_ind            <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"Ye…\n$ autonomous_ind     <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No…\n$ gifted_ind         <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"Ye…\n$ ip_ind             <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No…\n$ mothertongue1_code <chr> \"Chinese\", \"Chinese\", \"Chinese\", \"Chinese\", \"Chines…\n$ mothertongue2_code <chr> \"Malay\", \"Malay\", \"Malay\", \"Malay\", \"Malay\", \"Malay…\n$ mothertongue3_code <chr> \"Tamil\", \"Tamil\", \"Tamil\", \"Tamil\", \"Tamil\", \"na\", …\n$ results.SEARCHVAL  <chr> \"KIDZ TREEHOUSE @ CANTONMENT\", \"CHIJ SAINT THERESA'…\n$ results.BLK_NO     <chr> \"1\", \"160\", \"1\", \"1\", \"91\", \"147\", \"301\", \"50\", \"30…\n$ results.ROAD_NAME  <chr> \"CANTONMENT CLOSE\", \"LOWER DELTA ROAD\", \"BUKIT TERE…\n$ results.BUILDING   <chr> \"KIDZ TREEHOUSE @ CANTONMENT\", \"CHIJ SAINT THERESA'…\n$ results.ADDRESS    <chr> \"1 CANTONMENT CLOSE KIDZ TREEHOUSE @ CANTONMENT SIN…\n$ results.X          <chr> \"28748.1620587641\", \"26789.3781491434\", \"27402.9654…\n$ results.Y          <chr> \"28659.9995642845\", \"28647.4426490944\", \"28579.8478…\n$ results.LATITUDE   <chr> \"1.27546534984202\", \"1.27535177510054\", \"1.27474048…\n$ results.LONGITUDE  <chr> \"103.840041087946\", \"103.822440701642\", \"103.827954…\n```\n:::\n:::\n\n\nStep 4: Manually add Zhenghua Secondary School longitude and latitude into school.csv Google search output 1.3887°N 103.7652°E\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfind_na <- function(data) {\n  na_rows <- which(is.na(data$results.LATITUDE) | is.na(data$results.LONGITUDE))\n  na_schools <- data$school_name[na_rows]\n  return(na_schools)\n}\n\n# Usage:\nna_schools <- find_na(merged)\nprint(na_schools)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"ZHENGHUA SECONDARY SCHOOL\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Find the index of ZHENGHUA SECONDARY SCHOOL\nindex <- which(merged$school_name == \"ZHENGHUA SECONDARY SCHOOL\")\n\n# Add the specified values to the LATITUDE and LONGITUDE for this school\nmerged$results.LATITUDE[index] <- 1.3887\nmerged$results.LONGITUDE[index] <- 103.7652\n\n# Print the record for ZHENGHUA SECONDARY SCHOOL after the addition\nprint(merged[index, ])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    postal_code               school_name                       url_address\n257      677741 ZHENGHUA SECONDARY SCHOOL http://www.zhenghuasec.moe.edu.sg\n            address telephone_no telephone_no_2   fax_no fax_no_2\n257 91   SENJA ROAD     67639455             na 67633577       na\n             email_address     mrt_desc      bus_desc        principal_name\n257 ZHENGHUA_SS@MOE.EDU.SG JELAPANG LRT 920, 922, 976 MR LIN YUCHENG EUGENE\n        first_vp_name         second_vp_name third_vp_name fourth_vp_name\n257 MR PHOR HOAY GUAN MDM TAN PEI LEE ELAINE          NULL           NULL\n    fifth_vp_name sixth_vp_name      dgp_code zone_code         type_code\n257          NULL          NULL BUKIT PANJANG      WEST GOVERNMENT SCHOOL\n     nature_code   session_code mainlevel_code sap_ind autonomous_ind\n257 CO-ED SCHOOL SINGLE SESSION      SECONDARY      No             No\n    gifted_ind ip_ind mothertongue1_code mothertongue2_code mothertongue3_code\n257         No     No            Chinese              Malay              Tamil\n    results.SEARCHVAL results.BLK_NO results.ROAD_NAME results.BUILDING\n257              <NA>           <NA>              <NA>             <NA>\n    results.ADDRESS results.X results.Y results.LATITUDE results.LONGITUDE\n257            <NA>      <NA>      <NA>           1.3887          103.7652\n```\n:::\n:::\n\n\n\nStep 5: Import schools and rename columns\n\n\n::: {.cell}\n\n```{.r .cell-code}\nschool2 <- merged%>% \n  rename(latitude = results.LATITUDE,\n         longitude = results.LONGITUDE) %>% \n  select(postal_code, school_name, latitude, longitude)\n\nglimpse(school2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 350\nColumns: 4\n$ postal_code <chr> \"088256\", \"099138\", \"099757\", \"099840\", \"109100\", \"127368\"…\n$ school_name <chr> \"CANTONMENT PRIMARY SCHOOL\", \"CHIJ ST. THERESA'S CONVENT\",…\n$ latitude    <chr> \"1.27546534984202\", \"1.27535177510054\", \"1.27474048872023\"…\n$ longitude   <chr> \"103.840041087946\", \"103.822440701642\", \"103.827954007978\"…\n```\n:::\n:::\n\n\nStep 6: Convert aspatial data to sf tibble data frame Convert WGS84 (crs=4326) to SVY21 (crs=3414).\n\nThe output indicates **point** spatial object in **XY** dimension. There are 350 records. The projected CRS is **SVY21**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nschool_sf <- st_as_sf(school2,\n                       coords = c(\"longitude\", \"latitude\"),\n                       crs = 4326)%>% \n  st_transform(crs = 3414)\n\nhead(school_sf, n=5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 5 features and 2 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 25248.37 ymin: 28579.85 xmax: 28748.16 ymax: 28733.28\nProjected CRS: SVY21 / Singapore TM\n  postal_code                 school_name                  geometry\n1      088256   CANTONMENT PRIMARY SCHOOL    POINT (28748.16 28660)\n2      099138  CHIJ ST. THERESA'S CONVENT POINT (26789.38 28647.44)\n3      099757              CHIJ (KELLOCK) POINT (27402.97 28579.85)\n4      099840    RADIN MAS PRIMARY SCHOOL POINT (26983.87 28603.93)\n5      109100 BLANGAH RISE PRIMARY SCHOOL POINT (25248.37 28733.28)\n```\n:::\n:::\n\n\n# 5. Plot data\n\n::: panel-tabset\n\n## mpsz\n\nPlot a point simple feature layer using `school_sf`.\nNote: school_sf consists of spatial points, so it cannot accept tm_fill/tm_borders/tm_polygons.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#tmap_mode(\"view\")\ntmap_options(check.and.fix = TRUE)\n\ntm_shape(mpsz)+\n  tm_polygons()+\n  tm_shape(school_sf)+\n  tm_dots()+\n  tm_view(set.zoom.limits = c(11,12))+\n  tm_layout(title = \"Location of School in Subzones\", \n            title.position = c(\"right\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](In_class_Ex04_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntmap_mode(\"plot\") # release resources\n```\n:::\n\n## business\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_options(check.and.fix = TRUE)\n\ntm_shape(mpsz) +\n  tm_polygons() +\ntm_shape(business) +\n  tm_dots()+\n  tm_layout(title = \"Location of Business in Subzones\", \n            title.position = c(\"right\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](In_class_Ex04_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n# 5. Explore data\n\n## Count the number of schools within each planning subzone.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz$\"SCHOOL_COUNT\" <- lengths(\n  st_intersects(mpsz, school_sf)\n  )\n\nsummary(mpsz$SCHOOL_COUNT)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  0.000   0.000   0.000   1.054   2.000  12.000 \n```\n:::\n:::\n\n\nThe summary statistics above reveals that there are excessive 0 values in SCHOOL_COUNT field. If log() is going to use to transform this field, additional step is required to ensure that all 0 will be replaced with a value between 0 and 1 because log0 is infinity and log1 has a value.\n\n## Count the number of schools within each planning subzone.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz$\"BUSINESS_COUNT\" <- lengths(\n  st_intersects(mpsz, business)\n  )\n\nsummary(mpsz$BUSINESS_COUNT)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.00    0.00    2.00   19.73   13.00  307.00 \n```\n:::\n:::\n\n\n# 4. Integrate data\n\n`flow_data` is an sf tibble data.frame and the features are polylines linking the centroid of origins and destination planning subzone.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nflow_data <- read_rds(\"data/rds/flow_data_tidy.rds\")\nflow_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 14734 features and 12 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: 5105.594 ymin: 25813.33 xmax: 49483.22 ymax: 49552.79\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n   ORIGIN_SZ DESTIN_SZ MORNING_PEAK      dist ORIGIN_AGE7_12 ORIGIN_AGE13_24\n1     AMSZ01    AMSZ01         1998   50.0000            310             710\n2     AMSZ01    AMSZ02         8289  810.4491            310             710\n3     AMSZ01    AMSZ03         8971 1360.9294            310             710\n4     AMSZ01    AMSZ04         2252  840.4432            310             710\n5     AMSZ01    AMSZ05         6136 1076.7916            310             710\n6     AMSZ01    AMSZ06         2148  805.2979            310             710\n7     AMSZ01    AMSZ07         1620 1798.7526            310             710\n8     AMSZ01    AMSZ08         1925 2576.0199            310             710\n9     AMSZ01    AMSZ09         1773 1204.2846            310             710\n10    AMSZ01    AMSZ10           63 1417.8035            310             710\n   ORIGIN_AGE25_64 DESTIN_AGE7_12 DESTIN_AGE13_24 DESTIN_AGE25_64 SCHOOL_COUNT\n1             2780         310.00          710.00         2780.00         0.99\n2             2780        1140.00         2770.00        15700.00         2.00\n3             2780        1010.00         2650.00        14240.00         2.00\n4             2780         980.00         2000.00        11320.00         1.00\n5             2780         810.00         1920.00         9650.00         3.00\n6             2780        1050.00         2390.00        12460.00         2.00\n7             2780         420.00         1120.00         3620.00         0.99\n8             2780         390.00         1150.00         4350.00         0.99\n9             2780        1190.00         3260.00        13350.00         3.00\n10            2780           0.99            0.99            0.99         1.00\n   RETAIL_COUNT                       geometry\n1          1.00 LINESTRING (29501.77 39419....\n2          0.99 LINESTRING (29501.77 39419....\n3          6.00 LINESTRING (29501.77 39419....\n4          0.99 LINESTRING (29501.77 39419....\n5          0.99 LINESTRING (29501.77 39419....\n6          0.99 LINESTRING (29501.77 39419....\n7          1.00 LINESTRING (29501.77 39419....\n8        117.00 LINESTRING (29501.77 39419....\n9          0.99 LINESTRING (29501.77 39419....\n10        20.00 LINESTRING (29501.77 39419....\n```\n:::\n:::\n\n\nSelect the columns from `mpsz` to be appended to `flow_data`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_tidy <- mpsz %>%\n  st_drop_geometry() %>%\n  select(SUBZONE_C, SCHOOL_COUNT, BUSINESS_COUNT)\n```\n:::\n\n\nAppend SCHOOL_COUNT and BUSINESS_COUNT fields from mpsz_tidy data.frame into flow_data sf tibble data.frame\n\n\n::: {.cell}\n\n```{.r .cell-code}\nflow_data <- flow_data %>%\n  left_join(mpsz_tidy,\n            by = c(\"DESTIN_SZ\" = \"SUBZONE_C\")) %>%\n  rename(TRIPS = MORNING_PEAK,\n         DIST = dist)\n```\n:::\n\n\nChecking for variables with zero values\n\nSince Poisson Regression is based of log and log 0 is undefined, it is important for us to ensure that no 0 values in the explanatory variables. `summary()` of Base R is used to compute the summary statistics of all variables in wd_od data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(flow_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  ORIGIN_SZ          DESTIN_SZ             TRIPS             DIST      \n Length:14734       Length:14734       Min.   :     1   Min.   :   50  \n Class :character   Class :character   1st Qu.:    14   1st Qu.: 3346  \n Mode  :character   Mode  :character   Median :    76   Median : 6067  \n                                       Mean   :  1021   Mean   : 6880  \n                                       3rd Qu.:   426   3rd Qu.: 9729  \n                                       Max.   :232187   Max.   :26136  \n ORIGIN_AGE7_12    ORIGIN_AGE13_24    ORIGIN_AGE25_64    DESTIN_AGE7_12   \n Min.   :   0.99   Min.   :    0.99   Min.   :    0.99   Min.   :   0.99  \n 1st Qu.: 240.00   1st Qu.:  440.00   1st Qu.: 2200.00   1st Qu.: 240.00  \n Median : 700.00   Median : 1350.00   Median : 6810.00   Median : 720.00  \n Mean   :1031.86   Mean   : 2268.84   Mean   :10487.62   Mean   :1033.40  \n 3rd Qu.:1480.00   3rd Qu.: 3260.00   3rd Qu.:15770.00   3rd Qu.:1500.00  \n Max.   :6340.00   Max.   :16380.00   Max.   :74610.00   Max.   :6340.00  \n DESTIN_AGE13_24    DESTIN_AGE25_64    SCHOOL_COUNT.x    RETAIL_COUNT   \n Min.   :    0.99   Min.   :    0.99   Min.   : 0.990   Min.   :  0.99  \n 1st Qu.:  460.00   1st Qu.: 2200.00   1st Qu.: 0.990   1st Qu.:  0.99  \n Median : 1420.00   Median : 7030.00   Median : 1.000   Median :  3.00  \n Mean   : 2290.35   Mean   :10574.46   Mean   : 1.987   Mean   : 16.47  \n 3rd Qu.: 3260.00   3rd Qu.:15830.00   3rd Qu.: 2.000   3rd Qu.: 12.00  \n Max.   :16380.00   Max.   :74610.00   Max.   :12.000   Max.   :307.00  \n SCHOOL_COUNT.y   BUSINESS_COUNT            geometry    \n Min.   : 0.000   Min.   :  0.00   LINESTRING   :14734  \n 1st Qu.: 0.000   1st Qu.:  0.00   epsg:3414    :    0  \n Median : 1.000   Median :  3.00   +proj=tmer...:    0  \n Mean   : 1.583   Mean   : 16.17                        \n 3rd Qu.: 2.000   3rd Qu.: 12.00                        \n Max.   :12.000   Max.   :307.00                        \n```\n:::\n:::\n\nThe output shows that variables SCHOOL_COUNT and BUSINESS_COUNT consist of 0 values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#flow_data$SCHOOL_COUNT <- ifelse(\n#  flow_data$SCHOOL_COUNT == 0,\n#  0.99, flow_data$SCHOOL_COUNT)\n#flow_data$BUSINESS_COUNT <- ifelse(\n#  flow_data$BUSINESS_COUNT == 0,\n# 0.99, flow_data$BUSINESS_COUNT)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# write_rds(flow_data, \"data/rds/flow_data_tidy.rds\")\n```\n:::\n",
    "supporting": [
      "In_class_Ex04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}