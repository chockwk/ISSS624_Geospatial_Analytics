---
title: "Geospatial Analytics for Public Good"
author: "Wan Kee"
date: "25 November 2023"
date modified: "25 November 2023"
format: html
execute: 
  echo: true
  eval: true
  warning: false
editor: visual
---

# 1.1 Overview

# 1.2 Load packages

```{r}
pacman::p_load(knitr, mapview, spdep, tmap, tidyverse, sf)
```

# 1.3 Import data

::: panel-tabset
## busstops

`busstops` contains the detailed information for all bus stops currently being serviced by buses, including bus stop code, road name, description, location coordinates. Source: LTA DataMall ([Postman URL](http://datamall2.mytransport.sg/ltaodataservice/BusStops))

```{r}
busstops <- st_read(dsn = "data/BusStopLocation_Jul2023", layer = "BusStop") %>%
  st_transform(crs = 3414)
```

```{r}
glimpse(busstops)
```

The output indicates that the geospatial objects are **point** features. There are **5161 features** and 3 fields. It is in **SVY21** projected coordinates system with **XY** dimension.

## odbus

`odbus` contains the number of trips by weekdays and weekends from origin to destination bus stops. It indicates passenger volume for **October 2023**. Source: LTA DataMall ([Postman URL](http://datamall2.mytransport.sg/ltaodataservice/PV/ODBus))

```{r}
odbus = read_csv("data/origin_destination_bus_202310.csv")
odbus$ORIGIN_PT_CODE <- as.factor(odbus$ORIGIN_PT_CODE)
odbus$DESTINATION_PT_CODE <- as.factor(odbus$DESTINATION_PT_CODE)
glimpse(odbus)
```

The output does not indicate any geospatial objects. There are **5,694,297 records** and 7 fields.

## mpsz

Master Plan 2019 Subzone Boundary

The Master Plan is a forward looking guiding plan for Singapore's development in the medium term over the next 10 to 15 years published in **2019**. Note this `mpsz` differs from that in previous chapter, [Data Wrangling](https://cosmic-kitten.netlify.app/hands_on_ex/hands_on_ex01/hands_on_ex01).

`hexagon` is a hexagon layer of 250m (this distance is the perpendicular distance between the centre of the hexagon and its edges.) should be used to replace the relative coarse and irregular Master Plan 2019 Planning Sub-zone GIS data set of URA.

Source: URA (Download [here](https://beta.data.gov.sg/collections/1749/view))

::: {.callout-tip title="New Package"}
Using `st_read()` to import the new file returns an error: 'Error in CPL_get_z\_range(obj, 3) : z error - expecting three columns' `sf` expects a 3D geometry (X, Y, Z coordinates) but the file being read only contains 2D geometries (X and Y coordinates).

To resolve, we use `geojsonsf` to convert GeoJSON and simple feature objects.
:::

```{r}
#mpsz_2019 <- geojsonsf::geojson_sf("data/MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson")
#glimpse(mpsz_2019)
```

The output indicates that the geospatial objects are multipolygon features. There are 323 features and 15 fields. It is in SVY21 projected coordinates system with XY dimension.

```{r}
#mpsz_2019$geometry[[1]]
```

## hexagon

```{r}
# Create the hexagon grid
#hexagon <- st_make_grid(mpsz_2019, cellsize = c(250, 250 * sqrt(3)), 
#                        what = "polygons", 
#                        square = FALSE)

# Convert the grid to an sf object
#hexagon_sf <- st_sf(geometry = hexagon)

# Add a grid ID to each hexagon
#hexagon_sf$grid_id <- seq_along(hexagon_sf$geometry)
```

```{r}
#plot(st_geometry(mpsz_2019))
```

```{r}
#str(hexagon_sf)
```

```{r}
#mapview(hexagon_sf)
```

```{r}
# Load the necessary library
#library(jsonlite)

# Read the JSON file (assuming it's saved locally as 'bus_stops.json')
# Replace 'path_to_json_file.json' with the actual path to your JSON file
#bus_stops_json <- fromJSON('data/BusStops202310.json')

# The actual data is usually in a list within the JSON object, often named 'value' or similar
# Extract that list into a data frame
#bus_stops_df <- as.data.frame(bus_stops_json$value)

# Select only the columns that we are interested in
#bus_stops_df <- bus_stops_df[, c("BusStopCode", "RoadName", "Description", "Latitude", "Longitude")]

# Write the data frame to a CSV file
#write.csv(bus_stops_df, 'bus_stops.csv', row.names = FALSE)

```
:::

# 1.4 Explore data

```{r}
#st_geometry(mpsz_2019)
```

The output indicates that the geospatial objects are multipolygon features. There are 323 features and 15 fields. It is in SVY21 projected coordinates system with XY dimension.

# 1.5 Geovisualisation and Analysis

# 1.6 Local Indicators of Spatial Association (LISA) Analysis

# 1.7 Emerging Hot Spot Analysis (EHSA)

# 1.8 Plot data

# weekday evening peak passenger trips by origin; hexagons dont not have shared boundary; isolated with no neighbours but a hotspot. hexagon is a compact shape, grid is a regular geographic unit, rarely real world reflection to overcome odd shape geographical units.
