---
title: "Geospatial Analytics for Public Good"
author: "Wan Kee"
date: "25 November 2023"
date modified: "25 November 2023"
format: html
execute: 
  echo: true
  eval: true
  warning: false
editor: visual
---

# 1.1 Overview

# 1.2 Load packages

`sf` `dplyr` `mapview` `tmap`

```{r}
pacman::p_load(knitr, mapview, spdep, tmap, tidyverse, sf)
```

# 1.3 Import data

::: panel-tabset
## Bus Stops

`busstops` contains the detailed information for all bus stops currently being serviced by buses, including bus stop code, road name, description, location coordinates. Source: LTA DataMall ([Postman URL](http://datamall2.mytransport.sg/ltaodataservice/BusStops))

```{r}
busstops <- st_read(dsn = "data/BusStopLocation_Jul2023", layer = "BusStop") %>%
  st_transform(crs = 3414)
```

The output indicates that the geospatial objects are **point** features. There are **5161 features** and 3 fields. It is in **SVY21** projected coordinates system with **XY** dimension.

## Population

Geospatial statistics are published by the Singapore Department of Statistics. They are available from the Population Trends, Census of Population and General Household Survey reports. Singapore Residents by Planning Area/Subzone, Age Group, Sex and Floor Area of Residence, June 2011 onwards

PA - Planning Area
SZ - Subzone
AG - Age Group
Sex - Sex
FA - Floor Area of Residence
Pop - Resident Count
Time - Time / Period

1) For June 2011 to 2019, Planning Areas refer to areas demarcated in the Urban Redevelopment Authority's Master Plan 2014.
2) For June 2020, Planning Areas refer to areas demarcated in the Urban Redevelopment Authority's Master Plan 2019.
3) Data from 2003 onwards exclude residents who have been away from Singapore for a continuous period of 12 months or longer as at the reference period.
4) The figures have been rounded to the nearest 10. 
5) The data may not add up due to rounding.

Source: Department of Statistics ([Link](https://www.singstat.gov.sg/-/media/files/find_data/population/statistical_tables/respopagesexfa2011to2020.ashx))

```{r}
popdata <- read_csv("data/respopagesexfa2011to2020/respopagesexfa2011to2020.csv")
```
## Passenger Volume
`odbus` contains the number of trips by weekdays and weekends from origin to destination bus stops. It indicates passenger volume for **October 2023**. Source: LTA DataMall ([Postman URL](http://datamall2.mytransport.sg/ltaodataservice/PV/ODBus))

```{r}
odbus = read_csv("data/origin_destination_bus_202310.csv")
```
The output does not indicate any geospatial objects. There are **5,694,297 records** and 7 fields.

## Subzone

Master Plan 2019 Subzone Boundary

The Master Plan is a forward looking guiding plan for Singapore's development in the medium term over the next 10 to 15 years published in **2019**. Note this `mpsz` differs from that in previous chapter, [Data Wrangling](https://cosmic-kitten.netlify.app/hands_on_ex/hands_on_ex01/hands_on_ex01).

`hexagon` is a hexagon layer of 250m (this distance is the perpendicular distance between the centre of the hexagon and its edges.) should be used to replace the relative coarse and irregular Master Plan 2019 Planning Sub-zone GIS data set of URA.

Source: URA (Download [here](https://beta.data.gov.sg/collections/1749/view))

```{r}
mpsz = st_read(dsn="data/MPSZ-2019", layer="MPSZ-2019") %>% 
  st_transform(crs=3414)
```

The output indicates that the geospatial objects are **multipolygon** features. There are **332 features** and 6 fields. It is in **WGS84** projected coordinates system with **XY** dimension.

```{r}
# Assuming mpsz is your sf object
#mpsz <- st_read(dsn="data/MP19_SUBZONE", layer="MP19_SUBZONE_NO_SEA")

# Ensure that 'geometry' is the active geometry column
#mpsz <- st_set_geometry(mpsz, "geometry")

# Check for invalid geometries and apply st_make_valid if needed
#mpsz$geometry_is_valid <- st_is_valid(mpsz$geometry)
#mpsz <- mpsz %>%
#  mutate(geometry = ifelse(!geometry_is_valid, st_make_valid(geometry), geometry))

# Now, remove the Z dimension explicitly if it exists
#mpsz <- st_zm(mpsz, drop = TRUE, what = "Z")

# View the data structure to confirm changes
#print(mpsz1)
```

::: {.callout-tip title="Warning"}
Warning: GDAL Message 1: Sub-geometry 0 has coordinate dimension 2, but container has 3
:::

The warning message indicate that a discrepancy in the dimensionality of the geometries in `mpsz` Shapefile. Some of the sub-geometries have 2D coordinates (X and Y), while the overall container expects 3D coordinates (X, Y, and Z). The `st_zm(what = "Z")` function drops the Z dimension from the geometries, which eliminate the warnings about coordinate dimensions. We are not performing 3D analysis, this approach should work fine for most applications.

## Hexagon

Spatial grids are commonly used in spatial analysis to divide the study area into equal size, regular polygons that tessellate the area of interest. On the selection of grid, regular geographic units, such as square grid or fishnets, rarely reflect real world situations. Hexagons are compact shape and can overcome oddly-shaped geographical units.

Step 1: Create a hexgonal grid

```{r}
# Create hexagonal grid (250m from center to edges)
area_hexagon_grid = st_make_grid(busstops, cellsize = 500, what = "polygons", square = FALSE)
area_hexagon_grid
```

Step 2: Add Grid ID

```{r}
hexagon_grid_sf = st_sf(area_hexagon_grid) %>% 
  mutate(grid_id = 1:length(lengths(area_hexagon_grid)))
hexagon_grid_sf
```

Step 3: Count the number of bus stops in each grid and remove grids without any value.

```{r}
hexagon_grid_sf$grid_id = lengths(st_intersects(hexagon_grid_sf, busstops))
hexagon_count = filter(hexagon_grid_sf, grid_id>0)
```

Step 4: Set tmap to view mode for interactive plotting.

```{r}
tmap_mode("view")
hexagon = tm_shape(hexagon_count)+
  tm_fill(
    col = "grid_id",
    palette = "Reds",
    style = "cont",
    title = "Number of Bus Stops",
    id = "grid_id",
    showNA = FALSE,
    alpha = 0.6,
    popup.format = list(
      grid_id = list(format = "f", digits = 0)
    )
  )+
  tm_borders(col = "grey40", lwd = 0.7)
hexagon
```
:::

# 1.4 Explore data

::: panel-tabset
## Bus Stops

```{r}
glimpse(busstops)
```

```{r}
location = mapview(busstops, cex = 3, alpha = 0.5, popup = NULL)
location
```

```{r}
# Filter hexagons that contain more than 8 bus stops
hexagon_red = filter(hexagon_grid_sf, grid_id>8)

tmap_mode("view")
redhex = tm_shape(hexagon_red)+
  tm_fill(
    col = "grid_id",
    palette = "Reds",
    style = "cont",
    title = "Number of Bus Stops",
    id = "grid_id",
    showNA = FALSE,
    alpha = 0.6,
    popup.format = list(
      grid_id = list(format = "f", digits = 0)
    )
  )+
  tm_borders(col = "grey40", lwd = 0.7)
redhex
```

Sembawang MRT (9 bus stops)

![](images/Screenshot%202023-11-26%20at%206.01.46%E2%80%AFPM.png){fig-align="left" width="700"}

Pasir Ris (11 bus stops)

![](images/Screenshot%202023-11-27%20at%202.20.59%E2%80%AFAM.png){fig-align="left" width="700"}

## Population
```{r}
glimpse(popdata)
```
## Passenger Volume

```{r}
odbus$ORIGIN_PT_CODE <- as.factor(odbus$ORIGIN_PT_CODE)
odbus$DESTINATION_PT_CODE <- as.factor(odbus$DESTINATION_PT_CODE)
glimpse(odbus)
```

## Subzone

```{r}
glimpse(mpsz)
```
:::

# 1.5 Plot data

::: panel-tabset
# Bus Stops

```{r}

```
:::

# 1.6 Geovisualisation and Analysis

# 1.6 Local Indicators of Spatial Association (LISA) Analysis

# 1.7 Emerging Hot Spot Analysis (EHSA)

# weekday evening peak passenger trips by origin; hexagons dont not have shared boundary; isolated with no neighbours but a hotspot.
